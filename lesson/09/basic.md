# 【演習-09】ここまでのテクニックを使った組み合わせ演習2

## 目的

- ある処理の結果を次の処理に引き渡し複雑な処理を実装する方法を知る。
- パイプラインを用いた入出力のイメージをつける。
- 以下のコマンドの使い方を理解する。
    - `grep`

## Step1

- 以下の作業は全て`~/shellscript-training/lesson/09`配下にて実施します。対象ディレクトリに移動します。

```bash
cd ~/shellscript-training/lesson/09
```

- 以下の処理を行うシェルスクリプトのファイル(lesson_09_1.sh)を`artifacts`に作成します。  
    - `ls`コマンドの実行結果と`grep`コマンドをパイプラインでつないで、`~/shellscript-training/lesson/09/artifacts`ディレクトリ内にある`file_`から始まるファイルの名前を取得します。(※本演習では`~/shellscript-training/lesson/09/artifacts`ディレクトリにあらかじめ`file_20220725.txt`というファイルを配置しています。)
    - `file_`から始まるファイル名を取得できたか(ファイルが存在しているか)を判定し、以下の条件で出力を行う処理を実装します。
        - 取得できている場合…取得したファイル名をターミナル上に表示する。
            - なお、複数のファイルが該当する場合には以下のように複数ファイル名が空白区切りで1行に並んで出力されるようにする。
            ```
            file_20220725.txt file_xxxx.txt
            ```
    - 取得できていない場合…"対象ファイルが存在しません"とターミナル上に表示して処理を終了する。
- 以下の条件下を作り、作成されたスクリプトを実行して想定された挙動であるかを確認します。
    - 条件1: file_20220725.txtが1ファイル存在している状態で実行
    - 条件2: `file_`から始まる別のファイルが追加された状態で実行
    - 条件3: `file_`から始まるファイルが1つも存在しない状態で実行(各ファイルを削除して実行)

<details>
<summary>ヒント</summary>
<div>

- `ls`コマンドは対象のディレクトリを引数に指定することで該当ディレクトリ配下に含まれるファイル一覧を標準出力します。
- `grep`コマンドは標準入力からの情報を受け取り、引数で指定されたキーワードで絞り込みを行います。
- 絞り込んだ結果を変数に格納し、その変数の内容をif、[]の条件式で評価することで処理を仕分けることができます。

</div>
</details>


### 解答・解説

<details>
<summary>解答・解説</summary>
<div>

- 以下の内容でlesson_09_1.shを作成します。

```bash
#!/bin/bash

filename=`ls ~/shellscript-training/lesson/09/artifacts | grep file_`
if [ -z "${filename}"  ] ; then
  echo "対象ファイルが存在しません"
  exit 1
else
  echo $filename
fi
```

- filenameというシェル変数に、lsコマンド、grepコマンド実行結果の標準出力内容を格納しています。
- lsコマンドとgrepコマンドは`|`を使用することでlsの標準出力結果をgrepの標準入力に引き渡し絞り込み処理を行っています。
- -zによる評価を利用することで、filenameのシェル変数の文字列の長さがゼロかどうかを判定して処理を実行しています。
    - この時、`""`ダブルクォーテーションで変数を囲わずに単純に`${filename}`と記載した場合、`file_`から始まる文字列が複数件存在すると、`${filename}`の展開結果が「`file_20220725.txt file_xxxx.txt`」のように空白区切りの内容となります。
    - そのため、[]の中で展開された結果としては`[ -z file_20220725.txt file_xxxx.txt ]`となり条件式指定の表記が不正な形式となります。
    - 実行した際に`binary operator expected`といったキーワードのエラーメッセージが出た場合には上記が原因と考えられます。

</div>
</details>

以上。

## Advanced

- 時間の余裕があれば以下の情報も確認してみましょう。
- [Advanced](./advanced.md)

---

[演習-10のページへ](../10/basic.md)